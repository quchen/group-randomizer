<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript">
        const parseGroups = rawInput => {

            const cleanEntry = x => {
                return x.trim();
            };

            return rawInput
                .split("\n")
                .map(line => line.split(","))
                .map(line => line.map(entry => cleanEntry(entry)))
                .map(line => line.filter(entry => entry.length > 0))
                .filter(line => line.length > 0)
        };

        const findAndSplit = (list, p) => {
            const ix = list.findIndex(p);
            if(ix < 0) {
                throw new Error("findAndSplit: nothing found");
            }

            const before = list.slice(0, ix);
            const after = list.slice(ix+1, list.length);
            return [before, list[ix], after]
        }

        const testFindAndSplit = () => {
            const lolJsArrayEqual = (xs, ys) => xs.length === ys.length && xs.every((value, index) => value === ys[index])
            const splitAndReassemble = (input, p) => {
                const [before, x, after] = findAndSplit(input, p);
                console.assert(lolJsArrayEqual([...before, x, ...after], input), before, x, after);
            }
            list = [1,2,3,4,5,6,7,8,9];
            splitAndReassemble(list, x => x >= 3); // Happy path
            splitAndReassemble(list, x => x == 1); // First element
            splitAndReassemble(list, x => x == 9); // Last element
        }
        testFindAndSplit();


        const pickRandomGroup = groups => {

            // A group of size N has probability of 1/N of being picked. This leaves
            // the individualâ€™s probability invariant under the size of the group
            // they are participating in.
            const weight = group => { return 1 / group.length };

            var cumulativeWeight = 0;
            const weightedGroups = groups.map(group => {
                cumulativeWeight += weight(group);
                return {
                    gWeight: weight(group),
                    cWeight: cumulativeWeight,
                    participants: group
                }
            });
            const totalWeight = cumulativeWeight;
            const threshold = Math.random() * totalWeight;
            const [before, winner, after] = findAndSplit(weightedGroups, group => threshold <= group.cWeight);
            const losers = before.concat(after);
            return { winner: winner.participants, rest: losers.map(loser => loser.participants) }
        }

        const roll = (groups, maxParticipants) => {
            var participants = 0;
            var unpickedGroups = groups;
            var winners = []
            while(participants < maxParticipants && unpickedGroups.length > 0) {
                const { winner, rest } = pickRandomGroup(unpickedGroups);
                unpickedGroups = rest;
                participants += winner.length;
                winners.push(winner);
                console.log("winner", winner, "rest", rest);
            }
        };

        const main = () => {
            const box = document.getElementById("input");
            const rawInput = box.value;
            const groups = parseGroups(rawInput);
            roll(groups, 4);
        }
    </script>
</head>
<body>
    <textarea id="input" cols="80" rows="20">
    David, Andor, Johannes
    Janina, Mikey
    Annika, Maria, Raphi
    Vincent
    </textarea>
    <button onclick="main()">Go</button>
</body>
</html>
